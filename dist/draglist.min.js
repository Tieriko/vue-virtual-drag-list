!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("vue")):"function"==typeof define&&define.amd?define(["vue"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).VirtualDragList=e(t.Vue)}(this,function(t){"use strict";function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var i=e(t);function s(e,t){var i,n=Object.keys(e);return Object.getOwnPropertySymbols&&(i=Object.getOwnPropertySymbols(e),t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)),n}function p(n){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach(function(t){var e,i;e=n,t=r[i=t],i in e?Object.defineProperty(e,i,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[i]=t}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach(function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(r,t))})}return n}function o(t){return function(t){if(Array.isArray(t))return n(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return n(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(i="Object"===i&&t.constructor?t.constructor.name:i)||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?n(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}var a=(function(t){function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function r(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function s(t){return function(t){if(Array.isArray(t))return o(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return o(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(i="Object"===i&&t.constructor?t.constructor.name:i)||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?o(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}function e(t){if("undefined"!=typeof window&&window.navigator)return!!navigator.userAgent.match(t)}var a,l,u,h,c,d;t.exports=(a=e(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i),l=e(/safari/i)&&!e(/chrome/i)&&!e(/android/i),u={capture:!1,passive:!1},h={on:function(t,e,i){t.addEventListener(e,i,!a&&u)},off:function(t,e,i){t.removeEventListener(e,i,!a&&u)},getWindowScrollingElement:function(){var t=document.scrollingElement;return t||document.documentElement},index:function(t,e){return e&&e.parentNode?s(Array.from(t.children)).indexOf(e):-1},getRect:function(t,e){return!t.length||e<0?{}:t[e].getBoundingClientRect()},getElement:function(t,e){var i={index:-1,el:null,rect:{}},n=s(Array.from(t.children)),t=n.indexOf(e);-1<t&&Object.assign(i,{index:t,el:n[t],rect:n[t].getBoundingClientRect()});for(var r=0;r<n.length;r++)this.isChildOf(e,n[r])&&Object.assign(i,{index:r,el:n[r],rect:n[r].getBoundingClientRect()});return i},isChildOf:function(t,e){var i;if(t&&e)for(i=t.parentNode;i;){if(e===i)return!0;i=i.parentNode}return!1},animate:function(t,e){var i=this,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:300,r=t.getBoundingClientRect(),s=e.left-r.left,r=e.top-r.top;this.css(t,"transition","none"),this.css(t,"transform","translate3d(".concat(s,"px, ").concat(r,"px, 0)")),t.offsetLeft,this.css(t,"transition","all ".concat(n,"ms")),this.css(t,"transform","translate3d(0px, 0px, 0px)"),clearTimeout(t.animated),t.animated=setTimeout(function(){i.css(t,"transition",""),i.css(t,"transform",""),t.animated=null},n)},css:function(t,e,i){var n=t&&t.style;if(n){if(void 0===i)return document.defaultView&&document.defaultView.getComputedStyle?i=document.defaultView.getComputedStyle(t,""):t.currentStyle&&(i=t.currentStyle),void 0===e?i:i[e];n[e=!(e in n||-1!==e.indexOf("webkit"))?"-webkit-"+e:e]=i+("string"==typeof i?"":"px")}},debounce:function(r,s){return function(){for(var t=this,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];clearTimeout(r.id),r.id=setTimeout(function(){r.call.apply(r,[t].concat(i))},s)}}},c=function(){function t(){i(this,t),this.old={node:null,rect:{}},this.new={node:null,rect:{}}}return r(t,[{key:"get",value:function(t){return this[t]}},{key:"set",value:function(t,e){this[t]=e}},{key:"destroy",value:function(){this.old={node:null,rect:{}},this.new={node:null,rect:{}}}}]),t}(),d=function(){function e(t){i(this,e),this.options=t,this.x=0,this.y=0,this.exist=!1}return r(e,[{key:"init",value:function(t,e){if(t){this.$el=t,this.rect=e;var i,n=this.options,t=n.ghostClass,n=n.ghostStyle,r=void 0===n?{}:n,n=e.width,e=e.height;for(i in this.$el.class=t,this.$el.style.width=n+"px",this.$el.style.height=e+"px",this.$el.style.transform="",this.$el.style.transition="",this.$el.style.position="fixed",this.$el.style.left=0,this.$el.style.top=0,this.$el.style.zIndex=1e5,this.$el.style.opacity=.8,this.$el.style.pointerEvents="none",r)h.css(this.$el,i,r[i])}else console.error("Ghost Element is required")}},{key:"get",value:function(t){return this[t]}},{key:"set",value:function(t,e){this[t]=e,this[t]=e}},{key:"move",value:function(){this.exist||(document.body.appendChild(this.$el),this.exist=!0),this.$el.style.transform="translate3d(".concat(this.x,"px, ").concat(this.y,"px, 0)")}},{key:"destroy",value:function(){this.$el&&this.$el.remove(),this.exist=!1}}]),e}(),function(){function e(t){i(this,e),this.group=t.group,this.dragging=t.dragging,this.dragEnd=t.dragEnd,this.ghostStyle=t.ghostStyle,this.ghostClass=t.ghostClass,this.animation=t.animation||300,this.isMousedown=!1,this.isMousemove=!1,this.dragEl=null,this.dropEl=null,this.diff=new c,this.ghost=new d({ghostClass:this.ghostClass,ghostStyle:this.ghostStyle}),this.supportPointer="PointerEvent"in window&&!l,this.calcXY={x:0,y:0},h.debounce(this.init(),50)}return r(e,[{key:"init",value:function(){this.group?this._bindEventListener():console.error("Error: group is required")}},{key:"destroy",value:function(){this._unbindEventListener(),this._resetState()}},{key:"_onStart",value:function(t){if(0!==t.button)return!0;if(t.target===this.group)return!0;try{var e=this.dragging?this.dragging(t):t.target;if(!e)return!0;if(e.animated)return;this.dragEl=e}catch(t){return!0}this.isMousedown=!0;var i=h.getElement(this.group,this.dragEl),n=i.index,e=i.el,i=i.rect;if(!e||n<0)return!0;n=this.dragEl.cloneNode(!0);this.ghost.init(n,i),this.diff.old.rect=i,this.ghost.set("x",i.left),this.ghost.set("y",i.top),this.calcXY={x:t.clientX,y:t.clientY},this._onMoveEvents(),this._onUpEvents()}},{key:"_onMove",value:function(t){if(this.ghost.move(),t.preventDefault(),this.isMousedown&&!(t.clientX<0||t.clientY<0)){document.body.style.cursor="grabbing",this.isMousemove=!0,this.ghost.set("x",this.ghost.x+t.clientX-this.calcXY.x),this.ghost.set("y",this.ghost.y+t.clientY-this.calcXY.y),this.calcXY={x:t.clientX,y:t.clientY},this.ghost.move(),this._checkRange(t);var e=h.getElement(this.group,t.target),i=e.index,n=e.el,r=e.rect,s=r.left,o=r.right,e=r.top,r=r.bottom;if(n&&!(i<0)&&!(e<0||e-this.ghost.rect.height/3<0)&&t.clientX>s&&t.clientX<o&&t.clientY>e&&t.clientY<r){if(this.dropEl=n,this.dropEl!==this.dragEl){r=this.dragEl.getBoundingClientRect(),n=this.dropEl.getBoundingClientRect();if(this.dropEl.animated)return;h.index(this.group,this.dragEl)<i?this.group.insertBefore(this.dragEl,this.dropEl.nextElementSibling):this.group.insertBefore(this.dragEl,this.dropEl),h.animate(this.dragEl,r,this.animation),h.animate(this.dropEl,n,this.animation),this.diff.old.node=this.dragEl,this.diff.new.node=this.dropEl}this.diff.new.rect=this.dropEl.getBoundingClientRect()}}}},{key:"_onDrop",value:function(){this._offMoveEvents(),this._offUpEvents(),document.body.style.cursor="",this.isMousedown&&this.isMousemove&&this.dragEnd&&"function"==typeof this.dragEnd&&this.dragEnd(this.diff.old,this.diff.new),this.isMousedown=!1,this.isMousemove=!1,this.diff.destroy(),this.ghost.destroy()}},{key:"_checkRange",value:function(t){var e=this.group.getBoundingClientRect(),i=e.top,n=e.left,r=e.right,e=e.bottom;(t.clientX<n||t.clientX>r||t.clientY<i||t.clientY>e)&&(document.body.style.cursor="not-allowed")}},{key:"_resetState",value:function(){this.isMousedown=!1,this.isMousemove=!1,this.dragEl=null,this.dropEl=null,this.ghost.destroy(),this.diff=new c}},{key:"_bindEventListener",value:function(){this._onStart=this._onStart.bind(this),this._onMove=this._onMove.bind(this),this._onDrop=this._onDrop.bind(this),this.supportPointer?h.on(this.group,"pointerdown",this._onStart):h.on(this.group,"mousedown",this._onStart)}},{key:"_onMoveEvents",value:function(){this.supportPointer?h.on(document,"pointermove",this._onMove):h.on(document,"mousemove",this._onMove)}},{key:"_onUpEvents",value:function(){this.supportPointer?h.on(document,"pointerup",this._onDrop):h.on(document,"mouseup",this._onDrop)}},{key:"_unbindEventListener",value:function(){h.off(this.group,"mousedown",this._onStart),h.off(this.group,"pointerdown",this._onStart)}},{key:"_offMoveEvents",value:function(){h.off(document,"mousemove",this._onMove),h.off(document,"pointermove",this._onMove)}},{key:"_offUpEvents",value:function(){h.off(document,"mouseup",this._onDrop),h.off(document,"pointerup",this._onDrop)}}]),e}())}(l={exports:{}}),l.exports),r={inject:["virtual"],data:function(){return{observer:null}},mounted:function(){var t=this;"undefined"!=typeof ResizeObserver&&(this.observer=new ResizeObserver(function(){t.onSizeChange()}),this.$el&&this.observer.observe(this.$el))},updated:function(){this.onSizeChange()},beforeDestroy:function(){this.observer&&(this.observer.disconnect(),this.observer=null)},methods:{onSizeChange:function(){this.virtual[this.event](this.uniqueKey,this.getCurrentSize())},getCurrentSize:function(){return this.$el?this.$el.offsetHeight:0}}},t={dataSource:{type:Array,default:function(){return[]}},dataKey:{type:String,required:!0},height:{type:String,default:"100%"},keeps:{type:Number,default:30},size:{type:Number},delay:{type:Number,default:10},draggable:{type:Boolean,default:!0},draggableOnly:{type:Boolean,default:!0},headerTag:{type:String,default:"div"},footerTag:{type:String,default:"div"},itemTag:{type:String,default:"div"},itemStyle:{type:Object,default:function(){return{}}},itemClass:{type:String,default:""},dragStyle:{type:Object,default:function(){return{backgroundImage:"linear-gradient(to bottom, rgba(255, 255, 255, 0.1) 0%, rgba(0, 0, 0, 0.1) 40%, rgba(0, 0, 0, 0.1) 98%, #FFFFFF 100%)"}}},dragElement:{type:Function}},l={tag:{type:String,default:"div"},event:{type:String},dragStyle:{type:Object,default:function(){return{}}},uniqueKey:{type:[String,Number]}},y=i.default.component("virtual-draglist-items",{mixins:[r],props:l,render:function(t){var e=this.tag,i=this.uniqueKey;return t(e,{key:i,attrs:{"data-key":i}},this.$slots.default)}}),m=i.default.component("virtual-draglist-slots",{mixins:[r],props:l,render:function(t){var e=this.tag,i=this.uniqueKey;return t(e,{key:i,attrs:{role:i}},this.$slots.default)}}),v=function(s){function t(){for(var t,e=this,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return u&&clearTimeout(u),l?(t=!u,u=setTimeout(function(){u=null},a),t&&(o=s.apply(this,n))):u=setTimeout(function(){s.apply(e,n)},a),o}var o,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:50,l=2<arguments.length&&void 0!==arguments[2]&&arguments[2],u=null;return t.cancel=function(){clearTimeout(u),u=null},t};return i.default.component("virtual-drag-list",{props:t,data:function(){return{list:[],sizeStack:new Map,start:0,end:0,offset:0,direction:"",uniqueKeys:[],lastCalcIndex:0,calcType:"INIT",calcSize:{average:0,total:0,fixed:0,header:0,footer:0},padding:{front:0,behind:0},dragState:{oldNode:null,oldItem:null,oldIndex:null,newNode:null,newItem:null,newIndex:null},drag:null}},provide:function(){return{virtual:this}},computed:{uniqueKeyLen:function(){return this.uniqueKeys.length-1},isFixedType:function(){return"FIXED"===this.calcType}},watch:{dataSource:{handler:function(t){this.init(t)},deep:!0,immediate:!0},draggable:{handler:function(t){var e=this;t?this.$nextTick(function(){e.initDraggable()}):this.destroyDraggable()},deep:!0,immediate:!0}},mounted:function(){this.end=this.start+this.keeps},beforeDestroy:function(){this.destroyDraggable()},methods:{getSize:function(t){return this.sizeStack.get(t)},getOffset:function(){return this.offset},scrollToBottom:function(){var t=this,e=this.$refs,i=e.bottomItem,e=e.virtualDragList;i&&(i=i.offsetTop,this.scrollToOffset(i));var n=this.$el.clientHeight,r=e.scrollTop,s=e.scrollHeight;setTimeout(function(){r+n<s&&t.scrollToBottom()},10)},scrollToTop:function(){this.$refs.virtualDragList.scrollTop=0},scrollToOffset:function(t){this.$refs.virtualDragList.scrollTop=t},scrollToIndex:function(t){t>=this.list.length-1?this.scrollToBottom():(t=this.getOffsetByIndex(t),this.scrollToOffset(t))},setList:function(t){this.list=t},setDragState:function(t){this.dragState=Object.assign({},this.dragState,t)},handleDragEnd:function(t){this.$emit("ondragend",t)},init:function(t){var e=this;this.list=o(t),this.uniqueKeys=this.list.map(function(t){return e.uniqueId(t)}),this.handleSourceDataChange(),this.updateSizeStack()},handleScroll:function(t){var e=this.$refs.virtualDragList,i=Math.ceil(this.$el.clientHeight),n=Math.ceil(e.scrollTop),r=Math.ceil(e.scrollHeight);n<0||r+1<n+i||!r||(this.direction=n<this.offset?"FRONT":"BEHIND",this.offset=n,e=this.getScrollOvers(),"FRONT"===this.direction?(this.handleFront(e),this.list.length&&n<=0&&this.$emit("top")):"BEHIND"===this.direction&&(this.handleBehind(e),r<=i+n&&this.$emit("bottom")))},handleFront:function(t){t>this.start||(t=Math.max(t-Math.round(this.keeps/3),0),this.checkRange(t,this.getEndByStart(t)))},handleBehind:function(t){t<this.start+Math.round(this.keeps/3)||this.checkRange(t,this.getEndByStart(t))},onItemResized:function(t,e){this.sizeStack.set(t,e),"INIT"===this.calcType?(this.calcSize.fixed=e,this.calcType="FIXED"):"FIXED"===this.calcType&&this.calcSize.fixed!==e&&(this.calcType="DYNAMIC",delete this.calcSize.fixed),"FIXED"!==this.calcType&&"undefined"!==this.calcSize.total&&(this.sizeStack.size<Math.min(this.keeps,this.uniqueKeys.length)?(this.calcSize.total=o(this.sizeStack.values()).reduce(function(t,e){return t+e},0),this.calcSize.average=Math.round(this.calcSize.total/this.sizeStack.size)):delete this.calcSize.total)},onHeaderResized:function(t,e){this.calcSize.header=e},onFooterResized:function(t,e){this.calcSize.footer=e},handleSourceDataChange:function(){var t=Math.max(this.start,0);this.updateRange(this.start,this.getEndByStart(t))},updateSizeStack:function(){var i=this;this.sizeStack.forEach(function(t,e){i.uniqueKeys.includes(e)||i.sizeStack.delete(e)})},checkRange:function(t,e){var i=this.keeps;this.uniqueKeys.length<=i?(t=0,e=this.uniqueKeyLen):e-t<i-1&&(t=e-i+1),this.start!==t&&this.updateRange(t,e)},updateRange:function(t,e){this.start=t,this.end=e,this.padding={front:this.getFront(),behind:this.getBehind()}},getScrollOvers:function(){var t=this.offset-this.calcSize.header;if(t<=0)return 0;if(this.isFixedType)return Math.floor(t/this.calcSize.fixed);for(var e,i,n=0,r=this.uniqueKeys.length;n<=r;){if(e=n+Math.floor((r-n)/2),(i=this.getOffsetByIndex(e))===t)return e;i<t?n=e+1:t<i&&(r=e-1)}return 0<n?--n:0},getFront:function(){return this.isFixedType?this.calcSize.fixed*this.start:this.getOffsetByIndex(this.start)},getBehind:function(){var t=this.uniqueKeyLen;return this.isFixedType?(t-this.end)*this.calcSize.fixed:this.lastCalcIndex===t?this.getOffsetByIndex(t)-this.getOffsetByIndex(this.end):(t-this.end)*this.getItemSize()},getOffsetByIndex:function(t){if(!t)return 0;for(var e,i=0,n=0;n<t;n++)i+="number"==typeof(e=this.sizeStack.get(this.uniqueKeys[n]))?e:this.getItemSize();return this.lastCalcIndex=Math.max(this.lastCalcIndex,t-1),this.lastCalcIndex=Math.min(this.lastCalcIndex,this.uniqueKeyLen),i},getItemIndex:function(e){var i=this;return this.list.findIndex(function(t){return i.uniqueId(e)==i.uniqueId(t)})},getItemSize:function(){return this.isFixedType?this.calcSize.fixed:this.calcSize.average||this.size},getEndByStart:function(t){return Math.min(t+this.keeps,this.uniqueKeyLen)},uniqueId:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",i=this.dataKey;return(Array.isArray(i)?i:i.replace(/\[/g,".").replace(/\]/g,".").split(".")).reduce(function(t,e){return(t||{})[e]},t)||e},initDraggable:function(){var r=this;this.destroyDraggable(),this.drag=new a({group:this.$refs.content,ghostStyle:this.dragStyle,dragging:function(t){var e=t.target.getAttribute("draggable");if(r.draggableOnly&&!e)return null;if(r.dragElement)return r.dragElement(t,r.$refs.content);for(var i=t.target;[].indexOf.call(r.$refs.content.children,i)<0;)i=i.parentNode;return i},dragEnd:function(t,e){var i,n;t.rect.top!==e.rect.top&&(i=t.node.getAttribute("data-key"),n=e.node.getAttribute("data-key"),r.dragState.oldNode=t.node,r.dragState.newNode=e.node,r.list.forEach(function(t,e){r.uniqueId(t)===i&&(r.dragState.oldItem=t,r.dragState.oldIndex=e),r.uniqueId(t)===n&&(r.dragState.newItem=t,r.dragState.newIndex=e)}),(e=o(r.list)).splice(r.dragState.oldIndex,1),e.splice(r.dragState.newIndex,0,r.dragState.oldItem),r.setList(e),r.handleDragEnd(e))}})},destroyDraggable:function(){this.drag&&this.drag.destroy(),this.drag=null},reset:function(){this.scrollToTop(),this.init(this.dataSource)}},render:function(n){var r=this,t=this.$slots,e=t.header,i=t.footer,s=this.height,o=this.padding,a=this.headerTag,l=this.footerTag,u=this.itemTag,h=this.itemStyle,c=this.itemClass,d=this.dragStyle,f=this.list,g=this.start,t=this.end;return n("div",{ref:"virtualDragList",on:{"&scroll":v(this.handleScroll,this.delay)},style:{height:s,overflow:"hidden auto",position:"relative"}},[e?n(m,{props:{tag:a,uniqueKey:"header",event:"onHeaderResized"}},e):null,n("div",{ref:"content",attrs:{role:"content"},style:{padding:"".concat(o.front,"px 0px ").concat(o.behind,"px")}},f.slice(g,t+1).map(function(t){var e=r.getItemIndex(t),i=r.uniqueId(t);return r.$scopedSlots.item?n(y,{key:i,props:{uniqueKey:i,dragStyle:d,tag:u,event:"onItemResized"},style:h,class:c},r.$scopedSlots.item({record:t,index:e,dataKey:i})):n(u,{key:i,attrs:{"data-key":i},style:p({height:"".concat(r.size,"px")},h),class:c},i)})),i?n(m,{props:{tag:l,uniqueKey:"footer",event:"onFooterResized"}},i):null,n("div",{ref:"bottomItem"})])}})});
