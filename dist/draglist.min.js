!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("vue")):"function"==typeof define&&define.amd?define(["vue"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).VirtualDragList=t(e.Vue)}(this,function(e){"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=t(e);function s(t,e){var n,i=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)),i}function y(i){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?s(Object(r),!0).forEach(function(e){var t,n;t=i,e=r[n=e],n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(r,e))})}return i}function o(e){return function(e){if(Array.isArray(e))return i(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return i(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?i(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var l=(function(e){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}e.exports=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.parent=e.groupElement,this.scrollElement=e.scrollElement||e.groupElement,this.dragElement=e.dragElement,this.dragEnd=e.dragEnd,this.cloneElementStyle=e.cloneElementStyle,this.cloneElementClass=e.cloneElementClass,this.delay=e.delay||300,this.rectList=[],this.isMousedown=!1,this.isMousemove=!1,this.drag={element:null,index:0,lastIndex:0},this.drop={element:null,index:0,lastIndex:0},this.clone={element:null,x:0,y:0,exist:!1},this.diff={old:{node:null,rect:{}},new:{node:null,rect:{}}},this._debounce(this.init(),50)}return function(e,t,n){t&&i(e.prototype,t);n&&i(e,n);Object.defineProperty(e,"prototype",{writable:!1})}(t,[{key:"init",value:function(){this.parent?(this._bindEventListener(),this._getChildrenRect()):console.error("Error: groupElement is required")}},{key:"destroy",value:function(){this._unbindEventListener(),this._resetState()}},{key:"_getChildrenRect",value:function(){this.rectList.length=0;var e,t=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return l(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,t=function(){};return{s:t,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,r=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw r}}}}(this.parent.children);try{for(t.s();!(e=t.n()).done;){var n=e.value;this.rectList.push(n.getBoundingClientRect())}}catch(e){t.e(e)}finally{t.f()}}},{key:"_handleMousedown",value:function(e){var o=this;if(0!==e.button)return!0;if(e.target===this.parent)return!0;this.rectList.length||this._getChildrenRect();try{var t=this.dragElement?this.dragElement(e):e.target;if(!t)return!0;this.drag.element=t}catch(e){return!0}this.isMousedown=!0;var l={x:e.clientX,y:e.clientY};this.clone.element=this.drag.element.cloneNode(!0);t=this._getElementIndex();this.diff.old.rect=this.rectList[t],this.clone.x=this.rectList[t].left,this.clone.y=this.rectList[t].top,this.drag.index=t,this.drag.lastIndex=t,document.onmousemove=function(e){if(o._initCloneElement(),o._handleCloneMove(),e.preventDefault(),o.isMousedown){o.isMousemove=!0,o.clone.x+=e.clientX-l.x,o.clone.y+=e.clientY-l.y,l.x=e.clientX,l.y=e.clientY,o._handleCloneMove();for(var t=0;t<o.rectList.length;t++){var n=o.rectList[t],i=n.left,r=n.right,s=n.top,n=n.bottom;if(e.clientX>i&&e.clientX<r&&e.clientY>s&&e.clientY<n){o.drop.element=o.parent.children[t],o.drop.lastIndex=t,o.drag.element!==o.drop.element&&(o.drag.index<t?(o.parent.insertBefore(o.drag.element,o.drop.element.nextElementSibling),o.drop.index=t-1):(o.parent.insertBefore(o.drag.element,o.drop.element),o.drop.index=t+1),o.drag.index=t,o._animate(o.drag.element,o.rectList[o.drag.index],o.rectList[o.drag.lastIndex]),o._animate(o.drop.element,o.rectList[o.drop.index],o.rectList[o.drop.lastIndex]),o.drag.lastIndex=t,o.diff.old.node=o.drag.element,o.diff.new.node=o.drop.element),o.diff.new.rect=o.rectList[t];break}}}},document.onmouseup=function(){document.onmousemove=null,document.onmouseup=null,o.isMousedown&&o.isMousemove&&o.dragEnd&&o.dragEnd(o.diff.old,o.diff.new),o.isMousedown=!1,o.isMousemove=!1,o._destroyClone(),o._clearDiff()}}},{key:"_initCloneElement",value:function(){for(var e in this.clone.element.class=this.cloneElementClass,this.clone.element.style.transition="none",this.clone.element.style.position="fixed",this.clone.element.style.left=0,this.clone.element.style.top=0,this.cloneElementStyle)this._styled(this.clone.element,e,this.cloneElementStyle[e]);this.clone.element.exist||(document.body.appendChild(this.clone.element),this.clone.element.exist=!0)}},{key:"_handleCloneMove",value:function(){this.clone.element.style.transform="translate3d(".concat(this.clone.x,"px, ").concat(this.clone.y,"px, 0)")}},{key:"_destroyClone",value:function(){this.clone.element&&this.clone.element.remove(),this.clone={element:null,x:0,y:0,exist:!1}}},{key:"_getElementIndex",value:function(){var e=Array.from(this.parent.children),t=this.drag.element,n=e.indexOf(t);if(-1<n)return n;for(var i=0;i<e.length;i++)if(this._isChildOf(t,e[i]))return i}},{key:"_isChildOf",value:function(e,t){var n;if(e&&t)for(n=e.parentNode;n;){if(t===n)return!0;n=n.parentNode}return!1}},{key:"_animate",value:function(e,t,n){var i=this;this._styled(e,"transition","none"),this._styled(e,"transform","translate3d(".concat(n.left-t.left,"px, ").concat(n.top-t.top,"px, 0)")),e.offsetLeft,this._styled(e,"transition","all ".concat(this.delay,"ms")),this._styled(e,"transform","translate3d(0px, 0px, 0px)"),clearTimeout(e.animated),e.animated=setTimeout(function(){i._styled(e,"transition",""),i._styled(e,"transform",""),e.animated=null},this.delay)}},{key:"_styled",value:function(e,t,n){var i=e&&e.style;if(i){if(void 0===n)return document.defaultView&&document.defaultView.getComputedStyle?n=document.defaultView.getComputedStyle(e,""):e.currentStyle&&(n=e.currentStyle),void 0===t?n:n[t];i[t=!(t in i)?"-webkit-"+t:t]=n+("string"==typeof n?"":"px")}}},{key:"_resetState",value:function(){this.isMousedown=!1,this.isMousemove=!1,this.rectList.length=0,this.drag={element:null,index:0,lastIndex:0},this.drop={element:null,index:0,lastIndex:0},this._destroyClone(),this._clearDiff()}},{key:"_clearDiff",value:function(){this.diff={old:{node:null,rect:{}},new:{node:null,rect:{}}}}},{key:"_bindEventListener",value:function(){this._handleMousedown=this._handleMousedown.bind(this),this._getChildrenRect=this._getChildrenRect.bind(this),this.parent.addEventListener("mousedown",this._handleMousedown),this.scrollElement.addEventListener("scroll",this._debounce(this._getChildrenRect,50)),window.addEventListener("scroll",this._debounce(this._getChildrenRect,50)),window.addEventListener("resize",this._debounce(this._getChildrenRect,50)),window.addEventListener("orientationchange",this._debounce(this._getChildrenRect,50))}},{key:"_unbindEventListener",value:function(){this.parent.removeEventListener("mousedown",this._handleMousedown),this.scrollElement.removeEventListener("scroll",this._getChildrenRect),window.removeEventListener("scroll",this._getChildrenRect),window.removeEventListener("resize",this._getChildrenRect),window.removeEventListener("orientationchange",this._getChildrenRect)}},{key:"_debounce",value:function(r,s){return function(){for(var e=this,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];clearTimeout(r.id),r.id=setTimeout(function(){r.call.apply(r,[e].concat(n))},s)}}}]),t}()}(a={exports:{}}),a.exports),r={inject:["virtual"],data:function(){return{observer:null}},mounted:function(){var e=this;"undefined"!=typeof ResizeObserver&&(this.observer=new ResizeObserver(function(){e.onSizeChange()}),this.$el&&this.observer.observe(this.$el))},updated:function(){this.onSizeChange()},beforeDestroy:function(){this.observer&&(this.observer.disconnect(),this.observer=null)},methods:{onSizeChange:function(){this.virtual[this.event](this.uniqueKey,this.getCurrentSize())},getCurrentSize:function(){return this.$el?this.$el.offsetHeight:0}}},e={dataSource:{type:Array,default:function(){return[]}},dataKey:{type:String,required:!0},height:{type:String,default:"100%"},keeps:{type:Number,default:30},size:{type:Number},delay:{type:Number,default:10},draggable:{type:Boolean,default:!0},draggableOnly:{type:Boolean,default:!0},headerTag:{type:String,default:"div"},footerTag:{type:String,default:"div"},itemTag:{type:String,default:"div"},itemStyle:{type:Object,default:function(){return{}}},itemClass:{type:String,default:""},dragStyle:{type:Object,default:function(){return{backgroundImage:"linear-gradient(to bottom, rgba(255, 255, 255, 0.1) 0%, rgba(0, 0, 0, 0.1) 40%, rgba(0, 0, 0, 0.1) 98%, #FFFFFF 100%)"}}},dragElement:{type:Function}},a={tag:{type:String,default:"div"},event:{type:String},dragStyle:{type:Object,default:function(){return{}}},uniqueKey:{type:[String,Number]}},m=n.default.component("virtual-draglist-items",{mixins:[r],props:a,render:function(e){var t=this.tag,n=this.uniqueKey;return e(t,{key:n,attrs:{"data-key":n}},this.$slots.default)}}),p=n.default.component("virtual-draglist-slots",{mixins:[r],props:a,render:function(e){var t=this.tag,n=this.uniqueKey;return e(t,{key:n,attrs:{role:n}},this.$slots.default)}}),v=function(s){function e(){for(var e,t=this,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return d&&clearTimeout(d),a?(e=!d,d=setTimeout(function(){d=null},l),e&&(o=s.apply(this,i))):d=setTimeout(function(){s.apply(t,i)},l),o}var o,l=1<arguments.length&&void 0!==arguments[1]?arguments[1]:50,a=2<arguments.length&&void 0!==arguments[2]&&arguments[2],d=null;return e.cancel=function(){clearTimeout(d),d=null},e};return n.default.component("virtual-drag-list",{props:e,data:function(){return{list:[],sizeStack:new Map,start:0,end:0,offset:0,direction:"",uniqueKeys:[],lastCalcIndex:0,calcType:"INIT",calcSize:{average:0,total:0,fixed:0,header:0,footer:0},padding:{front:0,behind:0},dragState:{oldNode:null,oldItem:null,oldIndex:null,newNode:null,newItem:null,newIndex:null},drag:null}},provide:function(){return{virtual:this}},computed:{uniqueKeyLen:function(){return this.uniqueKeys.length-1},isFixedType:function(){return"FIXED"===this.calcType}},watch:{dataSource:{handler:function(e){this.init(e)},deep:!0,immediate:!0},draggable:{handler:function(e){var t=this;e?this.drag||this.$nextTick(function(){t.initDraggable()}):this.drag&&this.destroyDraggable()},deep:!0,immediate:!0}},mounted:function(){this.end=this.start+this.keeps},beforeDestroy:function(){this.drag.destroy()},methods:{getSize:function(e){return this.sizeStack.get(e)},getOffset:function(){return this.offset},scrollToBottom:function(){var e=this,t=this.$refs,n=t.bottomItem,t=t.virtualDragList;n&&(n=n.offsetTop,this.scrollToOffset(n));var i=this.$el.clientHeight,r=t.scrollTop,s=t.scrollHeight;setTimeout(function(){r+i<s&&e.scrollToBottom()},10)},scrollToTop:function(){this.$refs.virtualDragList.scrollTop=0},scrollToOffset:function(e){this.$refs.virtualDragList.scrollTop=e},scrollToIndex:function(e){e>=this.list.length-1?this.scrollToBottom():(e=this.getOffsetByIndex(e),this.scrollToOffset(e))},setList:function(e){this.list=e},setDragState:function(e){this.dragState=Object.assign({},this.dragState,e)},handleDragEnd:function(e){this.$emit("ondragend",e)},init:function(e){var t=this;this.list=o(e),this.uniqueKeys=this.list.map(function(e){return t.uniqueId(e)}),this.handleSourceDataChange(),this.updateSizeStack()},handleScroll:function(e){var t=this.$refs.virtualDragList,n=Math.ceil(this.$el.clientHeight),i=Math.ceil(t.scrollTop),r=Math.ceil(t.scrollHeight);i<0||r+1<i+n||!r||(this.direction=i<this.offset?"FRONT":"BEHIND",this.offset=i,t=this.getScrollOvers(),"FRONT"===this.direction?(this.handleFront(t),this.list.length&&i<=0&&this.$emit("top")):"BEHIND"===this.direction&&(this.handleBehind(t),r<=n+i&&this.$emit("bottom")))},handleFront:function(e){e>this.start||(e=Math.max(e-Math.round(this.keeps/3),0),this.checkRange(e,this.getEndByStart(e)))},handleBehind:function(e){e<this.start+Math.round(this.keeps/3)||this.checkRange(e,this.getEndByStart(e))},onItemResized:function(e,t){this.sizeStack.set(e,t),"INIT"===this.calcType?(this.calcSize.fixed=t,this.calcType="FIXED"):"FIXED"===this.calcType&&this.calcSize.fixed!==t&&(this.calcType="DYNAMIC",delete this.calcSize.fixed),"FIXED"!==this.calcType&&"undefined"!==this.calcSize.total&&(this.sizeStack.size<Math.min(this.keeps,this.uniqueKeys.length)?(this.calcSize.total=o(this.sizeStack.values()).reduce(function(e,t){return e+t},0),this.calcSize.average=Math.round(this.calcSize.total/this.sizeStack.size)):delete this.calcSize.total)},onHeaderResized:function(e,t){this.calcSize.header=t},onFooterResized:function(e,t){this.calcSize.footer=t},handleSourceDataChange:function(){var e=Math.max(this.start,0);this.updateRange(this.start,this.getEndByStart(e))},updateSizeStack:function(){var n=this;this.sizeStack.forEach(function(e,t){n.uniqueKeys.includes(t)||n.sizeStack.delete(t)})},checkRange:function(e,t){var n=this.keeps;this.uniqueKeys.length<=n?(e=0,t=this.uniqueKeyLen):t-e<n-1&&(e=t-n+1),this.start!==e&&this.updateRange(e,t)},updateRange:function(e,t){this.start=e,this.end=t,this.padding={front:this.getFront(),behind:this.getBehind()}},getScrollOvers:function(){var e=this.offset-this.calcSize.header;if(e<=0)return 0;if(this.isFixedType)return Math.floor(e/this.calcSize.fixed);for(var t,n,i=0,r=this.uniqueKeys.length;i<=r;){if(t=i+Math.floor((r-i)/2),(n=this.getOffsetByIndex(t))===e)return t;n<e?i=t+1:e<n&&(r=t-1)}return 0<i?--i:0},getFront:function(){return this.isFixedType?this.calcSize.fixed*this.start:this.getOffsetByIndex(this.start)},getBehind:function(){var e=this.uniqueKeyLen;return this.isFixedType?(e-this.end)*this.calcSize.fixed:this.lastCalcIndex===e?this.getOffsetByIndex(e)-this.getOffsetByIndex(this.end):(e-this.end)*this.getItemSize()},getOffsetByIndex:function(e){if(!e)return 0;for(var t,n=0,i=0;i<e;i++)n+="number"==typeof(t=this.sizeStack.get(this.uniqueKeys[i]))?t:this.getItemSize();return this.lastCalcIndex=Math.max(this.lastCalcIndex,e-1),this.lastCalcIndex=Math.min(this.lastCalcIndex,this.uniqueKeyLen),n},getItemIndex:function(t){var n=this;return this.list.findIndex(function(e){return n.uniqueId(t)==n.uniqueId(e)})},getItemSize:function(){return this.isFixedType?this.calcSize.fixed:this.calcSize.average||this.size},getEndByStart:function(e){return Math.min(e+this.keeps,this.uniqueKeyLen)},uniqueId:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",n=this.dataKey;return(Array.isArray(n)?n:n.replace(/\[/g,".").replace(/\]/g,".").split(".")).reduce(function(e,t){return(e||{})[t]},e)||t},initDraggable:function(){var r=this;this.drag=new l({groupElement:this.$refs.content,cloneElementStyle:this.dragStyle,scrollElement:this.$refs.virtualDragList,dragElement:function(e){var t=e.target.getAttribute("draggable");if(r.draggableOnly&&!t)return null;if(r.dragElement)return r.dragElement(e,r.$refs.content);for(var n=e.target;[].indexOf.call(r.$refs.content.children,n)<0;)n=n.parentNode;return n},dragEnd:function(e,t){var n,i;e.rect.top!==t.rect.top&&(n=e.node.getAttribute("data-key"),i=t.node.getAttribute("data-key"),r.dragState.oldNode=e.node,r.dragState.newNode=t.node,r.list.forEach(function(e,t){r.uniqueId(e)===n&&(r.dragState.oldItem=e,r.dragState.oldIndex=t),r.uniqueId(e)===i&&(r.dragState.newItem=e,r.dragState.newIndex=t)}),(t=o(r.list)).splice(r.dragState.oldIndex,1),t.splice(r.dragState.newIndex,0,r.dragState.oldItem),r.setList(t),r.handleDragEnd(t))}})},destroyDraggable:function(){this.drag.destroy(),this.drag=null},reset:function(){this.scrollToTop(),this.init(this.dataSource)}},render:function(i){var r=this,e=this.$slots,t=e.header,n=e.footer,s=this.height,o=this.padding,l=this.headerTag,a=this.footerTag,d=this.itemTag,u=this.itemStyle,c=this.itemClass,h=this.dragStyle,f=this.list,g=this.start,e=this.end;return i("div",{ref:"virtualDragList",on:{"&scroll":v(this.handleScroll,this.delay)},style:{height:s,overflow:"hidden auto",position:"relative"}},[t?i(p,{props:{tag:l,uniqueKey:"header",event:"onHeaderResized"}},t):null,i("div",{ref:"content",attrs:{role:"content"},style:{padding:"".concat(o.front,"px 0px ").concat(o.behind,"px")}},f.slice(g,e+1).map(function(e){var t=r.getItemIndex(e),n=r.uniqueId(e);return r.$scopedSlots.item?i(m,{key:n,props:{uniqueKey:n,dragStyle:h,tag:d,event:"onItemResized"},style:u,class:c},r.$scopedSlots.item({record:e,index:t,dataKey:n})):i(d,{key:n,attrs:{"data-key":n},style:y({height:"".concat(r.size,"px")},u),class:c},n)})),n?i(p,{props:{tag:a,uniqueKey:"footer",event:"onFooterResized"}},n):null,i("div",{ref:"bottomItem"})])}})});
